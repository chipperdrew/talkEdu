{% extends "base.html" %}
{% load dictionary_extras %} {# For dictionary access to variable keys and key content #}
{% load honeypot %}
{% load staticfiles %}

{% block title %}Post {{ post.id }} - YouTalkEdu{% endblock title %}

{% block content %}
	<div class="move_right">
	{# Post Vote #}
		<div style="display:inline-block; width:150px">  
			<canvas id="myCanvas{{post.id}}" width="150" height="100">
         		   If you see this, your browser does not support HTML5 Canvas.
        		</canvas>
			<script	src="{% static 'js/vote_script.js' %}"></script>
			<script type="text/javascript">
				$(document).ready(function() {
					var canv = document.getElementById("myCanvas{{post.id}}");
					var draw = canv.getContext("2d");
					drawPulseOutline(draw);
					{% for user_type_key in user_color_dict %}
						draw.fillStyle = "{{ user_color_dict|get_item:user_type_key }}";
						drawPulse({{ user_dict|key:user_type_key}}, separationDist*({{ forloop.counter }}-1), draw);
					{% endfor %}
					drawMiddle({{ post.vote_percentage }}, draw);
				});
			</script>
			<p style="text-align:center">
				Overall: {{ post.vote_percentage }}<br/>Total Votes: {{ post.total_votes }}
			</p>
		</div>

	<div style="display:inline-block; width:800px">
		<h3>{{ post.title }}</h3>
		<p>{{ post.text }}</p><br/><br/>
		<p>Posted by: <a href="{% url 'user_page' user=post.user_id %}">{{ post.user_id }}</a></p>
		{% with u_type=post.user_id.user_type %}
		<p style="color:{{user_color_dict|get_item:u_type}}; font-weight:bold">{{ post.user_id.get_user_type_display }}</p>
		{% endwith %}
		<p>Posted at {{ post.time_created }}</p>

			{% if user.is_authenticated %}			
				<div style="display:inline-block">					
					<a href="{% url 'up_vote' id=post.id %}?next={{request.path}}?page={{ page }}">Up</a> &nbsp;
					<a href="{% url 'down_vote' id=post.id %}?next={{request.path}}?page={{ page }}">Down</a> &nbsp;
					<a href="{% url 'mark_as_spam' id=post.id %}?next={{request.path}}?page={{ page }}">Mark as spam</a>
				</div>			
				{% if post.user_id == request.user %}
				<div style="float:right; display:inline-block">
					<a href="{% url 'post_edit' id=post.id %}?next={{request.path}}">Edit</a>
					<a href="{% url 'post_delete' id=post.id %}?next=/"
					onclick="return confirm('Deleting your post will remove all related votes and comments. Proceed?')">Delete</a>
				</div>
				{% endif %}	
			{% endif %}
	</div>




	{# Comments -- Credit to Max Burstein on logic and design #}
	<br/><br/>
	<h3>Comments({{num_comments}})</h3>
	<script>
		$(document).ready(function(){
			$("#commenters").on("click", ".reply", function(event){
				event.preventDefault(); //Prevent reloading page
				var form = $("#id_comment_form").clone(true); //Clone comment form
				form.find('.parent').val($(this).parent().parent().parent().attr('id')); 
				//$(this).parent().parent().parent().attr('id') is the id of the post
				$(this).parent().append(form);
			});
		});
	</script>
	<style>
		ul p a {
			font-weight: bold;
			color: #ff982c;
			text-decoration: none;
		}

		#commenters {
			padding-left: 0px;
		}
        
		#commenters li {
			list-style-type: none;
		}

		.poster {
			font-size: 12px;
			color: #AAAAAA;
		}

		#postcomment ul {
			padding-left: 0px;
		}

		#postcomment ul li {
			list-style-type: none;
			padding-bottom: 5px;
		}

		#postcomment label {
			width: 74px;
			display: inline-block;
		}

		.comment_box {
			font-size: 14px;
			background: #0E0E0E;
			-webkit-border-radius: 10px;
			-moz-border-radius: 10px;
			border-radius: 10px;
			color: #FFFFFF;
			padding: 10px;
			margin-bottom: 10px;
			width:800px;
		}
	</style>
	
	{# Comment Form #}
	{% if user.is_authenticated %}
		{% if comment_form.errors %}
			<div class="alert alert-error">
			<button type="button" class="close" data-dismiss="alert">Ã—</button>
			{% for field in comment_form %} 
				{% if field.errors %}
					<li>{{ field.errors|striptags }}</li>
				{% endif %}
			{% endfor %}
			</div>
		{% endif %}
		<form id="id_comment_form" method="POST" action="{% url 'new_comment' post.id %}?next={{request.path}}">
			{% csrf_token %}
			{% render_honeypot_field %}
			<div class="fieldWrapper">
				{{ comment_form.content }}
				{{ comment_form.parent }}			
			</div>
			<button class="btn btn-success" name="comment_button" type="submit">Comment</button>	
		</form>
	{% else %}
		<p>Please login to comment.</p><br/><br/>
	{% endif %}		

	</div> {# End move_right div #}
	
	<ul id="commenters">
		{# Display dropdown: Show all or just top level #}
		<div class="btn-group">
			<a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
				Show
				<span class="caret"></span>
			</a>
			<ul class="dropdown-menu">
				{% if 'all' in request.path %}
					<li> <a href="{% url 'post_page' post.id%}">Only top-level comments</a></li>
					<li> <a href="{% url 'post_page_all' post.id%}">
					<img src="http://www.clker.com/cliparts/e/2/a/d/1206574733930851359Ryan_Taylor_Green_Tick.svg.med.png" style="height:10px; width:10px; align:left" /> All comments (make take time to load)</a>
					</li>

				{% else %}
					<li> <a href="{% url 'post_page' post.id%}"><img src="http://www.clker.com/cliparts/e/2/a/d/1206574733930851359Ryan_Taylor_Green_Tick.svg.med.png" style="height:10px; width:10px; align:left" /> Only top-level comments</a></li>
					<li> <a href="{% url 'post_page_all' post.id%}">All comments (make take time to load)</a></li>
				{% endif %}	
			</ul>
		</div>

		{# Comment and Vote Display #}
		{% for c in comment_tree %}
			<br/>
			<li id="{{c.id}}" class="comment_box" style="margin-left:{{c.depth|add:c.depth}}em">
			{# Vote Display #}
			<div style="display:inline-block; width:150px; clear:both">
				<canvas id="commentCanvas{{c.id}}" width="125" height="100">
         			   If you see this, your browser does not support HTML5 Canvas. Sorry :(
        			</canvas>
				<script type="text/javascript">
					$(document).ready(function() {
						var canv = document.getElementById("commentCanvas{{c.id}}");
						var draw = canv.getContext("2d");
						draw.strokeStyle = "White";
						drawPulseOutline(draw);
						{% for user_type_key in user_color_dict %}
							draw.fillStyle = "{{ user_color_dict|get_item:user_type_key }}";
							drawPulse(0.95, separationDist*({{ forloop.counter }}-1), draw);
						{% endfor %}
						drawMiddle(0.95, draw);
					});
				</script>
				<p style="text-align:center">
					Overall: 0<br/>Total Votes: 0
				</p>
			</div>

			{# Comment display #}
			<div style="display:inline-block; width:640px">
			<p class="poster"><a href="{% url 'user_page' user=c.user_id %}">{{c.user_id}}</a> - {{c.time_created}}</p>
			<p>{{c.content}}</p>
			<p>
				<a href="{% url 'show_replies' c.id %}?next={{request.path}}">Show replies({{c.children}})</a>&nbsp;		
				{% if user.is_authenticated %}			
					<a href="" class="reply">Reply</a>&nbsp;
					<a href="{% url 'comment_spam' id=c.id %}?next={{request.path}}">Mark as spam</a>&nbsp;
					{% if c.user_id == request.user %}
						<a href="{% url 'delete_comment' c.id %}?next={{request.path}}"
						onclick="return confirm('Your comment and any sub-comments will be permanently deleted. Continue?')">Delete</a>
					{% endif %}
			</p>
			</div>
				{% endif %}
			</li>
		{% empty %}
			<li>There are currently no comments. You can be first!</li>
		{% endfor %}
	</ul>
{% endblock content %}
